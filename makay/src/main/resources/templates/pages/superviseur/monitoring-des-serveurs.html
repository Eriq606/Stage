<div class="container-fluid pt-4 px-4" th:fragment="content">
    <div class="row">
        <div class="col-12">
            <div class="bg-secondary rounded p-4">
                <div class="d-flex align-items-start">
                    <div class="nav flex-column nav-pills me-3 border-right border-primary" id="v-pills-tab" role="tablist"
                        aria-orientation="vertical">
                        <button th:each="s:${serveurs}" class="nav-link" th:id="'v-pills-serveur-tab-'+${s.id}" data-bs-toggle="pill"
                            th:data-bs-target="'#v-pills-serveur-'+${s.id}" type="button" role="tab"
                            th:aria-controls="'v-pills-serveur-'+${s.id}" aria-selected="true" th:text="${s.nom}"></button>
                    </div>
                    <div class="tab-content" id="v-pills-tabContent">
                        <div th:each="s:${serveurs}" class="tab-pane fade" th:id="'v-pills-serveur-'+${s.id}" role="tabpanel" th:aria-labelledby="'v-pills-serveur-tab-'+${s.id}">
                            <table class="table">
                                <tbody th:id="'commandes-'+${s.id}">
                                    <tr th:each="c:${s.commandes}">
                                        <td><a th:text="${c.getPlaceLabel()}" href="#" data-bs-toggle="modal" th:data-bs-target="'#detailCommandeModal'+${c.id}"></a></td>
                                        <td th:text="${c.getHeure()}"></td>
                                        <div class="modal fade" th:id="'detailCommandeModal'+${c.id}" tabindex="-2" th:aria-labelledby="'detailCommandeModalLabel'+${c.id}" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h1 class="modal-title fs-5" th:id="'detailCommandeModalLabel'+${c.id}" th:text="${c.getPlaceLabel()}"></h1>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body table-responsive" th:id="'detailCommandeServeur'+${s.id}+'Commande'+${c.id}">
                                                        <!-- <div th:each="cf:${c.commandeFilles}" style="color: white;"> -->
                                                        <div th:each="cf:${c.commandeFilles}">
                                                            <p th:text="${cf.quantite}+' '+${cf.produit.nom}+' '+${cf.notes}"></p>
                                                            <p><ul>
                                                                <li th:each="cfa:${cf.accompagnements}" th:text="${cfa.nom}"></li>
                                                            </ul></p>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Retour</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const ip=/*[[${ip}]]*/"";
        const stompclient=new StompJs.Client({
            brokerURL:'ws://'+ip+':8080/messaging'
        });
        stompclient.activate();
        window.onbeforeunload=()=>{
            stompclient.deactivate();
        }
        function createCommandeFilleRow(cf, modalBody){
            const cfDiv = document.createElement('div');
            // cfDiv.style.color = 'white';

            // Quantite, produit nom, and notes
            const p = document.createElement('p');
            p.textContent = cf.quantite + ' ' + cf.produit.nom + ' ' + cf.notes;
            cfDiv.appendChild(p);

            // Accompagnements list
            const ul = document.createElement('ul');
            cf.accompagnements.forEach(cfa => {
                const li = document.createElement('li');
                li.textContent = cfa.nom; // cfa.nom
                ul.appendChild(li);
            });

            const accompagnementP = document.createElement('p');
            accompagnementP.appendChild(ul);
            cfDiv.appendChild(accompagnementP);
            modalBody.appendChild(cfDiv);
        }
        function createCommandeRow(commande, utilisateur) {
            // Create <tr> element
            const tr = document.createElement('tr');

            // Create <td> element with a link for place label
            const td1 = document.createElement('td');
            const a = document.createElement('a');
            a.textContent = commande.placeLabel; // Assuming c.getPlaceLabel() is commande.placeLabel
            a.href = "#";
            a.setAttribute('data-bs-toggle', 'modal');
            a.setAttribute('data-bs-target', '#detailCommandeModal' + commande.id);
            td1.appendChild(a);

            // Create second <td> element for time
            const td2 = document.createElement('td');
            td2.textContent = commande.heure; // Assuming c.getHeure() is commande.heure

            // Append the <td> elements to the <tr>
            tr.appendChild(td1);
            tr.appendChild(td2);

            // Create modal structure
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal fade';
            modalDiv.id = 'detailCommandeModal' + commande.id;
            modalDiv.tabIndex = -2;
            modalDiv.setAttribute('aria-labelledby', 'detailCommandeModalLabel' + commande.id);
            modalDiv.setAttribute('aria-hidden', 'true');

            const modalDialog = document.createElement('div');
            modalDialog.className = 'modal-dialog modal-dialog-centered';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            // Modal header
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';

            const modalTitle = document.createElement('h1');
            modalTitle.className = 'modal-title fs-5';
            modalTitle.id = 'detailCommandeModalLabel' + commande.id;
            modalTitle.textContent = commande.placeLabel; // c.getPlaceLabel()

            const closeButton = document.createElement('button');
            closeButton.className = 'btn-close';
            closeButton.setAttribute('data-bs-dismiss', 'modal');
            closeButton.setAttribute('aria-label', 'Close');

            modalHeader.appendChild(modalTitle);
            modalHeader.appendChild(closeButton);

            // Modal body
            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body table-responsive';
            modalBody.id="detailCommandeServeur"+utilisateur.id+"Commande"+commande.id;
            // Iterate over child commands (commandeFilles)
            commande.commandeFilles.forEach(cf => {
                createCommandeFilleRow(cf, modalBody);
            });

            // Modal footer
            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';

            const retourButton = document.createElement('button');
            retourButton.className = 'btn btn-secondary';
            retourButton.setAttribute('data-bs-dismiss', 'modal');
            retourButton.textContent = 'Retour';

            modalFooter.appendChild(retourButton);

            // Assemble modal content
            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);

            modalDialog.appendChild(modalContent);
            modalDiv.appendChild(modalDialog);

            // Append modalDiv to the document body (or a container)
            document.body.appendChild(modalDiv);

            return tr;
        }
        function modifierCommande(commandeFille, commande, utilisateur){
            const modalBody=document.getElementById("detailCommandeServeur"+utilisateur.id+"Commande"+commande.id);
            createCommandeFilleRow(commandeFille, modalBody);
        }
        function receiveNotificationCommande(){
            stompclient.subscribe("/notify/recevoir-nouvelle-commande", (commandeEnvoyee)=>{
                const envoiCommande=JSON.parse(commandeEnvoyee.body);
                let commande=envoiCommande.commande;
                commande.commandeFilles=envoiCommande.commandeFilles;
                const commandeRow=createCommandeRow(commande, envoiCommande.utilisateur);
                const commandes=document.getElementById("commandes-"+envoiCommande.utilisateur.id);
                commandes.insertBefore(commandeRow, commandes.firstChild);
            });
        }
        function receiveModificationCommande(){
            stompclient.subscribe("/notify/recevoir-modifier-commande", (commandeEnvoyee)=>{
                const envoiCommande=JSON.parse(commandeEnvoyee.body);
                let commande=envoiCommande.commande;
                const utilisateur=envoiCommande.utilisateur;
                for(let i=0;i<envoiCommande.commandeFilles.length;i++){
                    modifierCommande(envoiCommande.commandeFilles[i], commande, utilisateur);
                }
            });
        }
        function redirigerVersResetCache(){
            window.location.href="http://"+ip+":8080/reset-cache-superviseur";
        }
        function receiveNotificationRedirect(){
            stompclient.subscribe("/notify/receive-notify-redirect-superviseur", (message)=>{
                redirigerVersResetCache();
            });
        }
        stompclient.onConnect=(frame)=>{
            receiveNotificationCommande();
            receiveNotificationRedirect();
            receiveModificationCommande();
        };
        /*]]*/
    </script>
</div>