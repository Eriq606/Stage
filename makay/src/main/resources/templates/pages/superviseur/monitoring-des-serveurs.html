<div class="container-fluid pt-4 px-4" th:fragment="content">
    <div class="row">
        <div class="col-12">
            <div class="bg-secondary rounded p-4">
                <div id="alerte-envoye"></div>
                <div class="d-flex align-items-start">
                    <div class="nav flex-column nav-pills me-3 border-right border-primary" id="v-pills-tab" role="tablist"
                        aria-orientation="vertical">
                        <button th:each="s:${serveurs}" class="nav-link" th:id="'v-pills-serveur-tab-'+${s.id}" data-bs-toggle="pill"
                            th:data-bs-target="'#v-pills-serveur-'+${s.id}" type="button" role="tab"
                            th:aria-controls="'v-pills-serveur-'+${s.id}" aria-selected="true" th:text="${s.nom}"></button>
                    </div>
                    <div class="tab-content" id="v-pills-tabContent">
                        <div th:each="s:${serveurs}" class="tab-pane fade" th:id="'v-pills-serveur-'+${s.id}" role="tabpanel" th:aria-labelledby="'v-pills-serveur-tab-'+${s.id}">
                            <table class="table">
                                <tbody th:id="'commandes-'+${s.id}">
                                    <tr th:each="c:${s.commandes}">
                                        <td><a th:text="${c.recupererPlaceLabel()}" href="#" data-bs-toggle="modal" th:data-bs-target="'#detailCommandeModal'+${c.id}"></a></td>
                                        <td th:text="${c.recupererHeure()}"></td>
                                        <div class="modal fade" th:id="'detailCommandeModal'+${c.id}" tabindex="-2" th:aria-labelledby="'detailCommandeModalLabel'+${c.id}" aria-hidden="true">
                                            <div class="modal-dialog modal-dialog-centered">
                                                <div class="modal-content">
                                                    <div class="modal-header">
                                                        <h1 class="modal-title fs-5" th:id="'detailCommandeModalLabel'+${c.id}" th:text="${c.recupererPlaceLabel()}"></h1>
                                                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                                    </div>
                                                    <div class="modal-body table-responsive" th:id="'detailCommandeServeur'+${s.id}+'Commande'+${c.id}">
                                                        <nav>
                                                            <div class="nav nav-tabs" id="nav-tab" role="tablist">
                                                                <button class="nav-link active" th:id="'nav-commandes-tab'+${c.id}" data-bs-toggle="tab"
                                                                    th:data-bs-target="'#nav-commandes'+${c.id}" type="button" role="tab" th:aria-controls="'nav-commandes'+${c.id}"
                                                                    aria-selected="true">Commandes</button>
                                                                <button class="nav-link" th:id="'nav-paiements-tab'+${c.id}" data-bs-toggle="tab"
                                                                    th:data-bs-target="'#nav-paiements'+${c.id}" type="button" role="tab"
                                                                    th:aria-controls="'nav-paiements'+${c.id}" aria-selected="false">Paiements</button>
                                                            </div>
                                                        </nav>
                                                        <div class="tab-content pt-3" id="nav-tabContent">
                                                            <div class="tab-pane fade show active" th:id="'nav-commandes'+${c.id}" role="tabpanel" th:aria-labelledby="'nav-commandes-tab'+${c.id}">
                                                                <div th:each="cf:${c.commandeFilles}">
                                                                    <p class="d-flex justify-content-between">
                                                                        <span>
                                                                            <span style="font-weight: bold;" th:text="${cf.recupererMontantString()}+' : '"></span>
                                                                            <span th:text="${cf.quantite}+' '+${cf.produit.nom}"></span>
                                                                        </span>
                                                                        <span th:if="${cf.etat==0}" th:id="'boutons-actions-commandefille'+${cf.id}">
                                                                            <button th:data-idcommandefille="${cf.id}" th:data-action="${offert}" th:data-idcommande="${c.id}" class="btn btn-success action-superviseur">Offert</button>
                                                                            <button th:data-idcommandefille="${cf.id}" th:data-action="${annulee}" th:data-idcommande="${c.id}" class="btn btn-danger action-superviseur">Annuler</button>
                                                                            <img th:id="'loading'+${cf.id}" th:src="@{img/loading.gif}" width="50" alt="loading" style="display: none;">
                                                                        </span>
                                                                        <span th:unless="${cf.etat==0}">
                                                                            <span th:style="'color:'+${cf.recupererEtatCouleur()}" th:text="${cf.recupererEtatString()}"></span>
                                                                        </span>
                                                                    </p>
                                                                    <p style="font-style: italic;font-weight: lighter;font-size: small;" th:text="${cf.notes}"></p>
                                                                    <p><ul>
                                                                        <li th:each="cfa:${cf.accompagnements}" th:text="${cfa.nom}"></li>
                                                                    </ul></p>
                                                                </div>
                                                                <hr>
                                                                <p>
                                                                    <span>Montant total : </span>
                                                                    <span th:class="'montant-total-commande'+${c.id}" style="font-weight: bold;" th:text="${c.recupererMontantString()}"></span>
                                                                </p>
                                                            </div>
                                                            <div class="tab-pane fade" th:id="'nav-paiements'+${c.id}" role="tabpanel" th:aria-labelledby="'nav-paiements-tab'+${c.id}">
                                                                <p>Paiements:</p>
                                                                <div th:each="cp:${c.paiements}">
                                                                    <p>
                                                                        <span th:text="${cp.recupererHeure()}+' : '"></span>
                                                                        <span style="font-weight: bold;" th:text="${cp.recupererMontantString()}"></span>
                                                                        <span th:text="' ('+${cp.modePaiement.nom}+')'"></span>
                                                                    </p>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="modal-footer">
                                                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Retour</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <td th:class="'montant-total-commande'+${c.id}" style="font-weight: bold;" th:text="${c.recupererMontantString()}"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script th:inline="javascript">
        /*<![CDATA[*/
        const ip=/*[[${ip}]]*/"";
        const stompclient=new StompJs.Client({
            brokerURL:'ws://'+ip+':8080/messaging'
        });
        stompclient.activate();
        window.onbeforeunload=()=>{
            stompclient.deactivate();
        }
        function createCommandeFilleRow(cf, modalBody){
            const cfDiv = document.createElement('div');
            const p = document.createElement('p');
            p.textContent = cf.quantite + ' ' + cf.produit.nom + ' ' + cf.notes;
            cfDiv.appendChild(p);
            const ul = document.createElement('ul');
            cf.accompagnements.forEach(cfa => {
                const li = document.createElement('li');
                li.textContent = cfa.nom;
                ul.appendChild(li);
            });

            const accompagnementP = document.createElement('p');
            accompagnementP.appendChild(ul);
            cfDiv.appendChild(accompagnementP);
            modalBody.appendChild(cfDiv);
        }
        function createCommandeRow(commande, utilisateur) {
            const tr = document.createElement('tr');
            const td1 = document.createElement('td');
            const a = document.createElement('a');
            a.textContent = commande.placeLabel;
            a.href = "#";
            a.setAttribute('data-bs-toggle', 'modal');
            a.setAttribute('data-bs-target', '#detailCommandeModal' + commande.id);
            td1.appendChild(a);
            const td2 = document.createElement('td');
            td2.textContent = commande.heure;
            tr.appendChild(td1);
            tr.appendChild(td2);
            const modalDiv = document.createElement('div');
            modalDiv.className = 'modal fade';
            modalDiv.id = 'detailCommandeModal' + commande.id;
            modalDiv.tabIndex = -2;
            modalDiv.setAttribute('aria-labelledby', 'detailCommandeModalLabel' + commande.id);
            modalDiv.setAttribute('aria-hidden', 'true');

            const modalDialog = document.createElement('div');
            modalDialog.className = 'modal-dialog modal-dialog-centered';

            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';

            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';

            const modalTitle = document.createElement('h1');
            modalTitle.className = 'modal-title fs-5';
            modalTitle.id = 'detailCommandeModalLabel' + commande.id;
            modalTitle.textContent = commande.placeLabel;

            const closeButton = document.createElement('button');
            closeButton.className = 'btn-close';
            closeButton.setAttribute('data-bs-dismiss', 'modal');
            closeButton.setAttribute('aria-label', 'Close');

            modalHeader.appendChild(modalTitle);
            modalHeader.appendChild(closeButton);

            const modalBody = document.createElement('div');
            modalBody.className = 'modal-body table-responsive';
            modalBody.id="detailCommandeServeur"+utilisateur.id+"Commande"+commande.id;
            commande.commandeFilles.forEach(cf => {
                createCommandeFilleRow(cf, modalBody);
            });

            const modalFooter = document.createElement('div');
            modalFooter.className = 'modal-footer';

            const retourButton = document.createElement('button');
            retourButton.className = 'btn btn-secondary';
            retourButton.setAttribute('data-bs-dismiss', 'modal');
            retourButton.textContent = 'Retour';

            modalFooter.appendChild(retourButton);

            modalContent.appendChild(modalHeader);
            modalContent.appendChild(modalBody);
            modalContent.appendChild(modalFooter);

            modalDialog.appendChild(modalContent);
            modalDiv.appendChild(modalDialog);

            document.body.appendChild(modalDiv);

            return tr;
        }
        function modifierCommande(commandeFille, commande, utilisateur){
            const modalBody=document.getElementById("detailCommandeServeur"+utilisateur.id+"Commande"+commande.id);
            createCommandeFilleRow(commandeFille, modalBody);
        }
        function receiveNotificationCommande(){
            stompclient.subscribe("/notify/recevoir-nouvelle-commande", (commandeEnvoyee)=>{
                const envoiCommande=JSON.parse(commandeEnvoyee.body);
                let commande=envoiCommande.commande;
                commande.commandeFilles=envoiCommande.commandeFilles;
                const commandeRow=createCommandeRow(commande, envoiCommande.utilisateur);
                const commandes=document.getElementById("commandes-"+envoiCommande.utilisateur.id);
                commandes.insertBefore(commandeRow, commandes.firstChild);
            });
        }
        function receiveModificationCommande(){
            stompclient.subscribe("/notify/recevoir-modifier-commande", (commandeEnvoyee)=>{
                const envoiCommande=JSON.parse(commandeEnvoyee.body);
                let commande=envoiCommande.commande;
                const utilisateur=envoiCommande.utilisateur;
                for(let i=0;i<envoiCommande.commandeFilles.length;i++){
                    modifierCommande(envoiCommande.commandeFilles[i], commande, utilisateur);
                }
            });
        }
        function redirigerVersResetCache(){
            window.location.href="http://"+ip+":8080/reset-cache-superviseur";
        }
        function receiveNotificationRedirect(){
            stompclient.subscribe("/notify/receive-notify-redirect-superviseur", (message)=>{
                redirigerVersResetCache();
            });
        }
        stompclient.onConnect=(frame)=>{
            receiveNotificationCommande();
            receiveNotificationRedirect();
            receiveModificationCommande();
        };

        const actionButtons=document.getElementsByClassName("action-superviseur");
        const api="http://"+ip+":8080/action-superviseur";
        const utilisateur=/*[[${utilisateur}]]*/{};
        const sessionid=/*[[${sessionid}]]*/"";
        const alerteEnvoye=document.getElementById("alerte-envoye");
        for(let i=0;i<actionButtons.length;i++){
            const idcommandefille=actionButtons[i].dataset.idcommandefille;
            const action=actionButtons[i].dataset.action;
            const idcommande=actionButtons[i].dataset.idcommande;
            const loading=document.getElementById("loading"+idcommandefille);
            actionButtons[i].onclick=()=>{
                const envoiAction={
                    utilisateur:utilisateur,
                    sessionid:sessionid,
                    actionSuperviseur:{
                        commandeFille:{id:idcommandefille},
                        action:action
                    }
                }
                loading.style.display="block";
                fetch(api, {
                    method:"post",
                    headers:{
                        "Content-type":"application/json"
                    },
                    body:JSON.stringify({restdata:JSON.stringify(envoiAction)})
                }).then((response)=>{return response.json()})
                .then((data)=>{
                    loading.style.display="none";
                    if(data.code==0){
                        const alert=document.createElement("div");
                        alert.className="alert alert-danger alert-dismissible show w-100";
                        alert.setAttribute("role", "alert");
                        alert.innerHTML=data.message;
                        const button = document.createElement('button');
                        button.type = 'button';
                        button.className = 'btn-close';
                        button.setAttribute('data-bs-dismiss', 'alert');
                        button.setAttribute('aria-label', 'Close');
                        alert.appendChild(button);
                        alerteEnvoye.appendChild(alert);
                        return;
                    }
                    const boutonsActions=document.getElementById("boutons-actions-commandefille"+idcommandefille);
                    const actionSpan=document.createElement("span");
                    actionSpan.style.color=data.donnees.couleur;
                    actionSpan.style.fontWeight="bold";
                    actionSpan.textContent=data.donnees.etat;
                    boutonsActions.innerHTML="";
                    boutonsActions.appendChild(actionSpan);
                    const montantTotalCmd=document.getElementsByClassName("montant-total-commande"+idcommande);
                    for(let j=0;j<montantTotalCmd.length;j++){
                        montantTotalCmd[j].textContent=new Intl.NumberFormat("de-DE").format(data.donnees.nouveauMontant).replace(".", " ")+" Ar";
                    }
                });
            }
        }
        /*]]*/
    </script>
</div>